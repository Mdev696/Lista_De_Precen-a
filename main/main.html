<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relat√≥rio Geral - Presen√ßa</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #3498db;
            --light: #ecf0f1;
            --rj-color: #2980b9;
            --es-color: #e67e22;
            --danger: #e74c3c;
            --success: #27ae60;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f0f2f5;
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: auto;
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid var(--light);
            padding-bottom: 20px;
            margin-bottom: 25px;
        }

        .uf-summary {
            display: flex;
            gap: 20px;
            margin-bottom: 25px;
        }

        .summary-card {
            flex: 1;
            padding: 20px;
            border-radius: 10px;
            color: white;
            text-align: left;
            transition: transform 0.2s;
        }

        .summary-rj {
            background: linear-gradient(135deg, #2980b9, #3498db);
        }

        .summary-es {
            background: linear-gradient(135deg, #e67e22, #f39c12);
        }

        .filter-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 25px;
            border: 1px solid #e9ecef;
            align-items: flex-end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        label {
            font-size: 10px;
            font-weight: 800;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        select,
        input {
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 13px;
            outline: none;
            transition: border-color 0.2s;
            background-color: white;
        }

        select:focus,
        input:focus {
            border-color: var(--accent);
        }

        .table-wrapper {
            overflow-x: auto;
            max-height: 600px;
            border: 1px solid #eee;
            border-radius: 8px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        th {
            background: #f8f9fa;
            color: var(--primary);
            padding: 15px;
            text-align: left;
            position: sticky;
            top: 0;
            border-bottom: 2px solid #dee2e6;
            z-index: 10;
        }

        td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
        }

        tr:hover {
            background-color: #f8fbff;
        }

        .status-badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 10px;
            background: #e9ecef;
            color: #495057;
            text-transform: uppercase;
        }

        .btn-back {
            background: var(--primary);
            color: white;
            text-decoration: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 14px;
        }

        .btn-clear {
            background: #fff;
            color: var(--danger);
            border: 1px solid var(--danger);
            border-radius: 6px;
            cursor: pointer;
            padding: 10px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .btn-clear:hover {
            background: var(--danger);
            color: white;
        }

        .btn-edit {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 5px;
        }

        .btn-delete {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
        }

        .no-data {
            text-align: center;
            padding: 50px;
            color: #adb5bd;
            font-style: italic;
        }
    </style>
</head>

<body>

    <div class="container">
        <header>
            <h2 style="margin:0; color: var(--primary);">üìã Relat√≥rio Geral de Presen√ßa</h2>
            <a href="index.html" class="btn-back">+ Novo Lan√ßamento</a>
        </header>

        <div class="uf-summary">
            <div class="summary-card summary-rj">
                <div style="font-size: 11px; opacity: 0.9; font-weight: bold;">TOTAL RIO DE JANEIRO</div>
                <div id="total-rj" style="font-size: 28px; font-weight: bold;">0</div>
            </div>
            <div class="summary-card summary-es">
                <div style="font-size: 11px; opacity: 0.9; font-weight: bold;">TOTAL ESP√çRITO SANTO</div>
                <div id="total-es" style="font-size: 28px; font-weight: bold;">0</div>
            </div>
        </div>

        <div class="filter-bar">
            <div class="filter-group">
                <label>üìÖ Data do Registro</label>
                <input type="date" id="filtroData" onchange="aplicarFiltros()">
            </div>
            <div class="filter-group">
                <label>üìç Unidade Federal</label>
                <select id="filtroUF" onchange="atualizarFiltrosCascata()">
                    <option value="">Todas as UFs</option>
                    <option value="RJ">Rio de Janeiro</option>
                    <option value="ES">Esp√≠rito Santo</option>
                </select>
            </div>
            <div class="filter-group">
                <label>üë§ Supervisor</label>
                <select id="filtroSuper" onchange="aplicarFiltros()">
                    <option value="">Todos</option>
                </select>
            </div>
            <div class="filter-group">
                <label>üèóÔ∏è Micro √Årea</label>
                <select id="filtroMicro" onchange="aplicarFiltros()">
                    <option value="">Todas</option>
                </select>
            </div>
            <div class="filter-group">
                <label>üö• Status</label>
                <select id="filtroStatus" onchange="aplicarFiltros()">
                    <option value="">Todos os Status</option>
                </select>
            </div>
            <div class="filter-group">
                <button class="btn-clear" onclick="limparFiltros()">Limpar Filtros</button>
            </div>
        </div>

        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th>Data</th>
                        <th>UF</th>
                        <th>Colaborador</th>
                        <th>Supervisor</th>
                        <th>Micro √Årea</th>
                        <th>Empresa</th>
                        <th>Status</th>
                        <th style="text-align:center;">A√ß√µes</th>
                    </tr>
                </thead>
                <tbody id="corpoTabelaMain"></tbody>
            </table>
            <div id="mensagemVazia" class="no-data" style="display: none;">
                Nenhum registro encontrado para os filtros selecionados.
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://ftouwpfhjwfoupvhsnth.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ0b3V3cGZoandmb3VwdmhzbnRoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzNTk5MzIsImV4cCI6MjA4NTkzNTkzMn0.roTjDn8MWoHVqlGWeZ3s1SqzGv-wxlapZqzfzeJJBCQ';
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let todosOsRegistros = [];

        const listaStatusMap = {
            "1": "PRESENTE", "2": "PRESENTE - CONJUNTA (SWAP/N1)", "3": "PRESENTE - FORMATA√á√ÉO",
            "4": "PRESENTE - PREVENTIVA", "5": "INTERJORNADA(10h)", "6": "INTERMEDI√ÅRIO (13h)",
            "7": "INTERJORNADA(13h)", "8": "INTERJORNADA(16h)", "9": "INTERJORNADA (SEM RETORNO)",
            "10": "NOTURNO", "11": "F√âRIAS", "12": "INSS", "13": "ATESTADO", "14": "FOLGA"
        };

        const supervisoresPorUF = {
            "ES": ["BRUNO ALCANTARA", "ITALO COELHO", "LIVIO MOREIRA", "PABLO BATISTA", "RENAN ALVARINTO"],
            "RJ": [
                "ADRIANO TEIXEIRA PINHEIRO", "BRENO BEZERRA CORREA", "CARLOS HENRIQUE DE PAULA BATISTA",
                "CLOVIS BATISTA TORRES JUNIOR", "DIEGO CARDOSO", "HAROLDO SANT ANNA DA CUNHA",
                "LEANDRO MARTINS ABBUD", "LUCIANO INACIO DA SILVA", "RENATO COSTA MOREIRA",
                "RICARDO LUIZ SANTA ROSA", "RODRIGO CUNHA DE LIMA", "ROMULO E SILVA CABRAL", "WELLIGTON MORENO"
            ]
        };

        const microsPorUF = {
            "ES": ["CACHOEIRO", "CARIACICA", "COLATINA", "GUARAPARI", "ICONHA", "LINHARES", "SERRA", "S√ÉO MATEUS", "VIANA", "VILA VELHA"],
            "RJ": ["AMARELA", "AZUL - BARRA/JPA", "AZUL - CENTRO", "AZUL - GRAN.TIJUCA", "AZUL - NORTE", "AZUL - OEST", "AZUL - SUL", "B2B", "NOTURNO", "VERDE", "VERMELHA - BAIXADA", "VERMELHA - CAXIAS", "VERMELHA - INTERIOR"]
        };

        window.onload = async () => { await carregarDados(); };

        async function carregarDados() {
            const { data, error } = await _supabase
                .from('registros_presenca')
                .select('*')
                .limit(5000)
                .order('data', { ascending: false });

            if (error) {
                console.error("Erro Supabase:", error);
                return;
            }

            todosOsRegistros = data || [];
            popularFiltrosDinamicos();
            aplicarFiltros();
        }

        function atualizarFiltrosCascata() {
            const fUF = document.getElementById('filtroUF').value;
            const dadosFiltradosParaSelects = fUF === ""
                ? todosOsRegistros
                : todosOsRegistros.filter(r => (r.uf || "").toUpperCase() === fUF);

            popularFiltrosDinamicos(dadosFiltradosParaSelects, false);
            aplicarFiltros();
        }

        function popularFiltrosDinamicos(lista = todosOsRegistros, resetStatus = true) {
            const selectSuper = document.getElementById('filtroSuper');
            const selectMicro = document.getElementById('filtroMicro');
            const selectStatus = document.getElementById('filtroStatus');

            const supers = [...new Set(lista.map(r => r.supervisor || r.super))].filter(Boolean).sort();
            const micros = [...new Set(lista.map(r => r.micro_area || r.micro))].filter(Boolean).sort();

            selectSuper.innerHTML = '<option value="">Todos</option>';
            selectMicro.innerHTML = '<option value="">Todas</option>';

            supers.forEach(s => selectSuper.add(new Option(s, s)));
            micros.forEach(m => selectMicro.add(new Option(m, m)));

            if (resetStatus) {
                const stats = [...new Set(todosOsRegistros.map(r => r.status))].filter(Boolean).sort();
                selectStatus.innerHTML = '<option value="">Todos os Status</option>';
                stats.forEach(st => selectStatus.add(new Option(st, st)));
            }
        }

        function aplicarFiltros() {
            const fData = document.getElementById('filtroData').value;
            const fUF = document.getElementById('filtroUF').value;
            const fSuper = document.getElementById('filtroSuper').value;
            const fMicro = document.getElementById('filtroMicro').value;
            const fStatus = document.getElementById('filtroStatus').value;

            const filtrados = todosOsRegistros.filter(r => {
                const rSuper = (r.supervisor || r.super || "").toString();
                const rUF = (r.uf || "").toString().trim().toUpperCase();
                const rStatus = (r.status || "").toString();
                const rMicro = (r.micro_area || r.micro || "").toString();

                return (fData === "" || r.data === fData) &&
                    (fUF === "" || rUF === fUF) &&
                    (fSuper === "" || rSuper === fSuper) &&
                    (fMicro === "" || rMicro === fMicro) &&
                    (fStatus === "" || rStatus === fStatus);
            });

            atualizarResumo(filtrados);
            exibirTabela(filtrados);
        }

        function atualizarResumo(listaParaSomar) {
            const contagemRJ = listaParaSomar.filter(r => (r.uf || "").trim().toUpperCase() === 'RJ').length;
            const contagemES = listaParaSomar.filter(r => (r.uf || "").trim().toUpperCase() === 'ES').length;
            document.getElementById('total-rj').innerText = contagemRJ;
            document.getElementById('total-es').innerText = contagemES;
        }

        function exibirTabela(lista) {
            const tbody = document.getElementById('corpoTabelaMain');
            const msgVazia = document.getElementById('mensagemVazia');
            tbody.innerHTML = "";

            if (lista.length === 0) {
                msgVazia.style.display = "block";
                return;
            }

            msgVazia.style.display = "none";
            lista.forEach((r) => {
                const dataBR = r.data ? r.data.split('-').reverse().join('/') : "---";
                const rUF = (r.uf || "").toString().trim().toUpperCase();
                const corUF = rUF === 'RJ' ? 'var(--rj-color)' : 'var(--es-color)';

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${dataBR}</td>
                    <td><b style="color: ${corUF}">${rUF}</b></td>
                    <td><strong>${r.colaborador || r.colab || "N/A"}</strong></td>
                    <td>${r.supervisor || r.super || "N/A"}</td>
                    <td>${r.micro_area || r.micro || ''}</td>
                    <td>${r.empresa || ''}</td>
                    <td><span class="status-badge">${r.status || ''}</span></td>
                    <td style="text-align:center;">
                        <button class="btn-edit" onclick="editarRegistro('${r.id}')" title="Editar">‚úèÔ∏è</button>
                        <button class="btn-delete" onclick="excluirRegistro('${r.id}', '${r.colaborador || r.colab}')" title="Excluir">üóëÔ∏è</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        async function editarRegistro(id) {
            const reg = todosOsRegistros.find(r => r.id == id);
            if (!reg) return;

            const opcao = prompt(`Editar ${reg.colaborador || reg.colab}:\n1. Status\n2. Supervisor\n3. Micro √Årea`);

            if (opcao === "1") {
                let msg = "Escolha o Status:\n";
                for (let k in listaStatusMap) msg += `${k}. ${listaStatusMap[k]}\n`;
                const esc = prompt(msg);
                if (esc) {
                    const statusFinal = listaStatusMap[esc] || esc.toUpperCase().trim();
                    await _supabase.from('registros_presenca').update({ status: statusFinal }).eq('id', id);
                    await carregarDados();
                }
            } else if (opcao === "2") {
                const ufRegistro = (reg.uf || "").trim().toUpperCase();
                const listaSupers = supervisoresPorUF[ufRegistro] || [];
                await processarEdicaoLista(id, reg, "Supervisor", listaSupers, ('supervisor' in reg ? 'supervisor' : 'super'));
            } else if (opcao === "3") {
                const ufRegistro = (reg.uf || "").trim().toUpperCase();
                const listaMicros = microsPorUF[ufRegistro] || [];
                await processarEdicaoLista(id, reg, "Micro √Årea", listaMicros, ('micro_area' in reg ? 'micro_area' : 'micro'));
            }
        }

        async function processarEdicaoLista(id, reg, rotulo, lista, campoBanco) {
            if (lista.length === 0) {
                const novoValor = prompt(`Novo ${rotulo}:`, reg[campoBanco]);
                if (novoValor) await salvarCampo(id, campoBanco, novoValor);
                return;
            }

            let msg = `Escolha ${rotulo} (${reg.uf}):\n`;
            lista.forEach((item, idx) => msg += `${idx + 1}. ${item}\n`);

            const esc = prompt(msg);
            if (esc) {
                const idx = parseInt(esc) - 1;
                const valorFinal = lista[idx] || esc.toUpperCase().trim();
                await salvarCampo(id, campoBanco, valorFinal);
            }
        }

        async function salvarCampo(id, campo, valor) {
            await _supabase.from('registros_presenca').update({ [campo]: valor.toUpperCase().trim() }).eq('id', id);
            await carregarDados();
        }

        async function excluirRegistro(id, nome) {
            if (confirm(`Excluir registro de ${nome}?`)) {
                await _supabase.from('registros_presenca').delete().eq('id', id);
                await carregarDados();
            }
        }

        function limparFiltros() {
            document.getElementById('filtroData').value = "";
            document.getElementById('filtroUF').value = "";
            document.getElementById('filtroSuper').value = "";
            document.getElementById('filtroMicro').value = "";
            document.getElementById('filtroStatus').value = "";
            popularFiltrosDinamicos();
            aplicarFiltros();
        }
    </script>
</body>

</html>