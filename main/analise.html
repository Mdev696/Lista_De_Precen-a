<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anal√≠tico Operacional - Dashboard KPI</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #34495e;
            --accent: #348ddb;
            --success: #27ae60;
            --danger: #e74c3c;
            --warning: #f39c12;
            --light: #ecf0f1;
            --rj-color: #2980b9;
            --es-color: #e67e22;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f2f5;
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: auto;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 3px solid var(--accent);
            padding-bottom: 20px;
            margin-bottom: 25px;
        }

        .filtro-box {
            background: var(--light);
            padding: 20px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
            border: 1px solid #dcdde1;
        }

        input[type="date"] {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 15px;
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            margin-bottom: 20px;
        }

        th {
            background-color: var(--primary);
            color: white;
            padding: 12px;
            font-size: 10px;
            text-transform: uppercase;
        }

        .header-rj {
            background-color: var(--rj-color);
        }

        .header-es {
            background-color: var(--es-color);
        }

        td {
            padding: 15px;
            text-align: center;
            border-bottom: 1px solid #eee;
            font-size: 16px;
            font-weight: 700;
        }

        .txt-pr {
            color: var(--success);
        }

        .txt-f {
            color: var(--danger);
        }

        .txt-fo {
            color: var(--warning);
        }

        .txt-fe {
            color: var(--accent);
        }

        .txt-inss {
            color: #576574;
        }

        .txt-abs {
            color: #8e44ad;
            font-size: 20px;
            background: #f8f0fb;
            padding: 5px 10px;
            border-radius: 8px;
        }

        .btn-voltar {
            background: var(--secondary);
            color: white;
            padding: 10px 20px;
            text-decoration: none;
            border-radius: 6px;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>üìä Anal√≠tico de Indicadores KPI por UF</h1>
            <div style="display: flex; gap: 10px;">
                <a href="index.html" class="btn-voltar">‚¨Ö Voltar</a>
                <a href="Colab.html" class="btn-voltar">Colaborador</a>
                <a href="console.html" class="btn-voltar">Supervisor</a>
                <a href="gerconsole.html" class="btn-voltar">Coordenador</a>
                <a href="/B2B/index.html" class="btn-voltar">B2B</a>
            </div>
        </header>

        <div class="filtro-box">
            <strong>Data de Refer√™ncia:</strong>
            <input type="date" id="dataFiltro" onchange="gerarAnalise()">
        </div>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>UF</th>
                        <th>Efetivo</th>
                        <th>Desligado</th>
                        <th>PR Œ£x M-1</th>
                        <th>PR Œ£x W-1</th>
                        <th>PR D-1</th>
                        <th>N/A</th>
                        <th>PR (Presen√ßa)</th>
                        <th>F (Falta)</th>
                        <th>FO (Folga)</th>
                        <th>FE (F√©rias)</th>
                        <th>INSS</th>
                        <th>INTJ</th>
                        <th>ABS</th>
                    </tr>
                </thead>
                <tbody id="corpoTabela"></tbody>
            </table>
        </div>

      


    </div>



    <script>
        const SUPABASE_URL = 'https://ftouwpfhjwfoupvhsnth.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ0b3V3cGZoandmb3VwdmhzbnRoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzNTk5MzIsImV4cCI6MjA4NTkzNTkzMn0.roTjDn8MWoHVqlGWeZ3s1SqzGv-wxlapZqzfzeJJBCQ';
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const efetivoFixoUF = { 'RJ': 66, 'ES': 26 };

        async function gerarAnalise() {
            const dataSelecionada = document.getElementById('dataFiltro').value;
            const mesPrefixo = dataSelecionada.substring(0, 7);
            const corpo = document.getElementById('corpoTabela');
            corpo.innerHTML = "<tr><td colspan='14'>Sincronizando dados regionais...</td></tr>";

            const { data: registros, error } = await _supabase.from('registros_presenca').select('*');
            if (error) return;

            const ufs = ['RJ', 'ES'];
            let htmlFinal = "";

            ufs.forEach(uf => {
                const registrosUF = registros.filter(r => (r.uf || "").trim().toUpperCase() === uf);
                const efetivoFixo = efetivoFixoUF[uf];

                const registrosDoMesUF = registrosUF.filter(r => r.data && r.data.startsWith(mesPrefixo) && r.data <= dataSelecionada);
                const diasUnicosUF = [...new Set(registrosDoMesUF.map(r => r.data))];
                const totalDiasUF = diasUnicosUF.length || 1;

                let kpi = { pr_visual: 0, f: 0, fo: 0, fe: 0, intj_visual: 0, inss: 0, desl: 0, prD1: 0, sw1: 0, sm1: 0 };

                const d1_str = new Date(new Date(dataSelecionada + "T12:00:00").getTime() - 86400000).toISOString().split('T')[0];
                const w_limite = new Date(new Date(dataSelecionada + "T12:00:00").getTime() - (7 * 86400000));

                registrosUF.forEach(r => {
                    const status = r.status ? r.status.trim().toUpperCase() : "";
                    const rData = r.data;
                    const rDataObj = new Date(rData + "T12:00:00");

                    const ehINTJ = status.includes("INTERJORNADA") || status === "INTJ";
                    const ehPR_Puro = status.includes("PRESENTE") || status.includes("NOTURNO") || status.includes("INTERMEDIARIO") || status.includes("INTERMEDI√ÅRIO");

                    // Para o c√°lculo do ABS, a INTERJORNADA deve ser considerada trabalho para N√ÉO entrar na soma de aus√™ncias
                    const contaComoTrabalhoParaABS = ehPR_Puro || ehINTJ;

                    const ehDesl = status.includes("DESLIGADO");
                    const ehFalta = status.includes("FALTA") || status.includes("ATESTADO") || status.includes("DUPLADO") || status.includes("FROTA");
                    const ehFO = status.includes("FOLGA") || status === "FO";
                    const ehFE = status.includes("F√âRIAS") || status.includes("FERIAS") || status === "FE";
                    const ehINSS = status.includes("INSS");

                    if (rData === dataSelecionada) {
                        if (ehPR_Puro) kpi.pr_visual++;
                        if (ehINTJ) kpi.intj_visual++;

                        if (ehDesl) kpi.desl++;
                        if (ehFalta) kpi.f++;
                        if (ehFO) kpi.fo++;
                        if (ehFE) kpi.fe++;
                        if (ehINSS) kpi.inss++;
                    }

                    // Hist√≥rico (M-1, W-1, D-1) tamb√©m considera quem trabalhou (PR ou INTJ)
                    if (contaComoTrabalhoParaABS) {
                        if (rData === d1_str) kpi.prD1++;
                        if (rDataObj > w_limite && rDataObj <= new Date(dataSelecionada + "T12:00:00")) kpi.sw1++;
                        if (rData.startsWith(mesPrefixo) && rData <= dataSelecionada) kpi.sm1++;
                    }
                });

                const registrosNoDia = registrosUF.filter(r => r.data === dataSelecionada).length;
                const naoLancados = Math.max(0, efetivoFixo - registrosNoDia);

                // ABS FINAL: Apenas as faltas e aus√™ncias reais divididas pelo efetivo. 
                // A Interjornada N√ÉO entra nesta soma (ehINTJ n√£o est√° aqui).
                const somaAusencias = kpi.f + kpi.desl + kpi.fo + kpi.fe + kpi.inss;
                const valorABS = ((somaAusencias / efetivoFixo) * 100).toFixed(2);

                htmlFinal += `
                    <tr>
                        <td class="${uf === 'RJ' ? 'header-rj' : 'header-es'}" style="color:white; font-size: 20px;">${uf}</td>
                        <td>${efetivoFixo}</td>
                        <td style="color: var(--danger);">${kpi.desl}</td>
                        <td>${(kpi.sm1 / totalDiasUF).toFixed(1)}</td>
                        <td>${(kpi.sw1 / 7).toFixed(1)}</td>
                        <td>${kpi.prD1}</td>
                        <td style="color: #7f8c8d;">${naoLancados}</td>
                        <td class="txt-pr">${kpi.pr_visual}</td>
                        <td class="txt-f">${kpi.f}</td>
                        <td class="txt-fo">${kpi.fo}</td>
                        <td class="txt-fe">${kpi.fe}</td>
                        <td class="txt-inss">${kpi.inss}</td>
                        <td>${kpi.intj_visual}</td>
                        <td><span class="txt-abs">${valorABS}%</span></td>
                    </tr>
                `;
            });
            corpo.innerHTML = htmlFinal;
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('dataFiltro').value = new Date().toISOString().split('T')[0];
            gerarAnalise();
        });
    </script>
</body>

</html>