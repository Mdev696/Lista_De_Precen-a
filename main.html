<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relat√≥rio Administrativo - Presen√ßa</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #3498db;
            --light: #ecf0f1;
            --rj-color: #2980b9;
            --es-color: #e67e22;
            --danger: #e74c3c;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background: #f4f7f6;
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 1300px;
            margin: auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid var(--light);
            padding-bottom: 20px;
            margin-bottom: 20px;
        }

        .uf-summary {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .summary-card {
            flex: 1;
            padding: 15px;
            border-radius: 8px;
            color: white;
            text-align: center;
        }

        .summary-rj {
            background: var(--rj-color);
        }

        .summary-es {
            background: var(--es-color);
        }

        .filter-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            background: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #ddd;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        label {
            font-size: 11px;
            font-weight: bold;
            color: var(--primary);
            text-transform: uppercase;
        }

        select,
        input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        th {
            background: var(--primary);
            color: white;
            padding: 12px;
            text-align: left;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        td {
            padding: 10px;
            border-bottom: 1px solid #eee;
        }

        tr:hover {
            background-color: #f1faff;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-weight: bold;
            font-size: 10px;
            background: #e0e0e0;
            white-space: nowrap;
        }

        .btn-clear {
            background: #95a5a6;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            padding: 8px;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }
    </style>
</head>

<body>

    <div class="container">
        <header>
            <h1>üìã Relat√≥rio Administrativo</h1>
            <a href="index.html"
                style="text-decoration:none; background:var(--accent); color:white; padding:10px; border-radius:4px; font-weight:bold;">‚¨Ö
                Novo Lan√ßamento</a>
        </header>

        <div class="uf-summary">
            <div class="summary-card summary-rj">
                <div style="font-size: 11px;">REGISTROS RJ</div>
                <div id="total-rj" style="font-size: 22px; font-weight: bold;">0</div>
            </div>
            <div class="summary-card summary-es">
                <div style="font-size: 11px;">REGISTROS ES</div>
                <div id="total-es" style="font-size: 22px; font-weight: bold;">0</div>
            </div>
        </div>

        <div class="filter-bar">
            <div class="filter-group">
                <label>Data (Calend√°rio):</label>
                <input type="date" id="filtroData" onchange="aplicarFiltros()">
            </div>
            <div class="filter-group">
                <label>UF:</label>
                <select id="filtroUF" onchange="aplicarFiltros()">
                    <option value="">Todas</option>
                    <option value="RJ">RJ</option>
                    <option value="ES">ES</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Supervisor:</label>
                <select id="filtroSuper" onchange="aplicarFiltros()">
                    <option value="">Todos</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Status:</label>
                <select id="filtroStatus" onchange="aplicarFiltros()">
                    <option value="">Todos</option>
                </select>
            </div>
            <div class="filter-group" style="justify-content: flex-end;">
                <button class="btn-clear" onclick="limparFiltros()">Limpar Filtros</button>
            </div>
        </div>

        <div style="overflow-x:auto; max-height: 550px; border: 1px solid #eee;">
            <table>
                <thead>
                    <tr>
                        <th>Data</th>
                        <th>UF</th>
                        <th>Colaborador</th>
                        <th>Supervisor</th>
                        <th>Status</th>
                        <th style="text-align:center;">A√ß√µes</th>
                    </tr>
                </thead>
                <tbody id="corpoTabelaMain"></tbody>
            </table>
            <div id="mensagemVazia" class="no-data" style="display: none;">
                Nenhum registro encontrado.
            </div>
        </div>
    </div>

    <script>
        // Configura√ß√µes do Supabase
        const SUPABASE_URL = 'https://ftouwpfhjwfoupvhsnth.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ0b3V3cGZoandmb3VwdmhzbnRoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzNTk5MzIsImV4cCI6MjA4NTkzNTkzMn0.roTjDn8MWoHVqlGWeZ3s1SqzGv-wxlapZqzfzeJJBCQ';
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let todosOsRegistros = [];

        window.onload = carregarDados;

        async function carregarDados() {
            const { data, error } = await _supabase
                .from('registros_presenca')
                .select('*')
                .order('data', { ascending: false });

            if (error) {
                console.error("Erro ao carregar:", error.message);
                return;
            }

            todosOsRegistros = data || [];
            popularFiltrosDinamicos();
            aplicarFiltros();
        }

        function popularFiltrosDinamicos() {
            const selectSuper = document.getElementById('filtroSuper');
            const selectStatus = document.getElementById('filtroStatus');

            // Pegando valores √∫nicos para os filtros
            const supers = [...new Set(todosOsRegistros.map(r => r.supervisor))].filter(Boolean).sort();
            const stats = [...new Set(todosOsRegistros.map(r => r.status))].filter(Boolean).sort();

            selectSuper.innerHTML = '<option value="">Todos</option>';
            selectStatus.innerHTML = '<option value="">Todos</option>';

            supers.forEach(s => selectSuper.add(new Option(s, s)));
            stats.forEach(st => selectStatus.add(new Option(st, st)));
        }

        function aplicarFiltros() {
            const fData = document.getElementById('filtroData').value; // Formato YYYY-MM-DD
            const fUF = document.getElementById('filtroUF').value;
            const fSuper = document.getElementById('filtroSuper').value;
            const fStatus = document.getElementById('filtroStatus').value;

            const filtrados = todosOsRegistros.filter(r => {
                // BLINDAGEM DA DATA (DIA 01 A 12):
                // Tratamos o valor do banco como texto puro para evitar fuso hor√°rio
                const dataBancoTexto = r.data ? r.data.substring(0, 10) : "";

                const bateData = fData === "" || dataBancoTexto === fData;
                const bateUF = fUF === "" || r.uf === fUF;
                const bateSuper = fSuper === "" || r.supervisor === fSuper;
                const bateStatus = fStatus === "" || r.status === fStatus;

                return bateData && bateUF && bateSuper && bateStatus;
            });

            exibirTabela(filtrados);
        }

        function exibirTabela(lista) {
            const tbody = document.getElementById('corpoTabelaMain');
            const msgVazia = document.getElementById('mensagemVazia');
            tbody.innerHTML = "";

            let rjCount = 0;
            let esCount = 0;

            if (lista.length === 0) {
                msgVazia.style.display = "block";
            } else {
                msgVazia.style.display = "none";
                lista.forEach(r => {
                    if (r.uf === 'RJ') rjCount++;
                    if (r.uf === 'ES') esCount++;

                    // Inverte a data de YYYY-MM-DD para DD/MM/YYYY apenas para exibi√ß√£o visual
                    const dataFormatada = r.data ? r.data.substring(0, 10).split('-').reverse().join('/') : "---";
                    const corUF = r.uf === 'RJ' ? 'var(--rj-color)' : 'var(--es-color)';

                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${dataFormatada}</td>
                        <td><b style="color: ${corUF}">${r.uf}</b></td>
                        <td><strong>${r.colaborador || '---'}</strong></td>
                        <td>${r.supervisor || '---'}</td>
                        <td><span class="status-badge">${r.status || '---'}</span></td>
                        <td style="text-align:center;">
                            <button onclick="excluir('${r.id}')" style="cursor:pointer; border:none; background:none;">üóëÔ∏è</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            }

            document.getElementById('total-rj').innerText = rjCount;
            document.getElementById('total-es').innerText = esCount;
        }

        async function excluir(id) {
            if (confirm("Deseja realmente excluir este registro?")) {
                const { error } = await _supabase.from('registros_presenca').delete().eq('id', id);
                if (!error) carregarDados();
                else alert("Erro ao excluir.");
            }
        }

        function limparFiltros() {
            document.getElementById('filtroData').value = "";
            document.getElementById('filtroUF').value = "";
            document.getElementById('filtroSuper').value = "";
            document.getElementById('filtroStatus').value = "";
            aplicarFiltros();
        }
    </script>
</body>

</html>