<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anal√≠tico Operacional - Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #34495e;
            --accent: #348ddb;
            --success: #27ae60;
            --danger: #e74c3c;
            --warning: #f39c12;
            --light: #ecf0f1;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f2f5;
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 1300px;
            margin: auto;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 3px solid var(--accent);
            padding-bottom: 20px;
            margin-bottom: 25px;
        }

        .filtro-box {
            background: var(--light);
            padding: 20px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
            border: 1px solid #dcdde1;
        }

        input[type="date"] {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 15px;
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th {
            background-color: var(--primary);
            color: white;
            padding: 15px;
            font-size: 11px;
            text-transform: uppercase;
        }

        td {
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid #eee;
            font-size: 17px;
            font-weight: 700;
        }

        .txt-pr {
            color: var(--success);
        }

        .txt-f {
            color: var(--danger);
        }

        .txt-fo {
            color: var(--warning);
        }

        .txt-fe {
            color: var(--accent);
        }

        .txt-abs {
            color: #8e44ad;
            font-size: 22px;
            background: #f8f0fb;
            padding: 5px 10px;
            border-radius: 8px;
        }

        .btn-voltar {
            background: var(--secondary);
            color: white;
            padding: 10px 20px;
            text-decoration: none;
            border-radius: 6px;
            font-weight: bold;
        }

        .legenda {
            margin-top: 30px;
            padding: 15px;
            background: #fffdf0;
            border-left: 5px solid var(--warning);
            font-size: 13px;
        }
        

        /* --- ADAPTA√á√ÉO PARA CELULAR (MOBILE) --- */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .container {
                padding: 15px;
                border-radius: 10px;
            }

            header {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }

            header h1 {
                font-size: 1.5rem;
                margin-bottom: 10px;
            }

            /* Faz os bot√µes de navega√ß√£o ocuparem 100% da largura */
            .btn-voltar {
                display: block;
                width: 100%;
                box-sizing: border-box;
                margin-bottom: 5px;
                text-align: center;
            }

            /* Ajusta a caixa de filtro */
            .filtro-box {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
                padding: 15px;
            }

            input[type="date"] {
                width: 100%;
            }

            /* TRATAMENTO DA TABELA KPI */
            .table-container {
                margin-top: 10px;
                border: 1px solid #ddd;
                border-radius: 8px;
            }

            table {
                display: block;
                overflow-x: auto;
                /* Ativa o scroll lateral no dedo */
                white-space: nowrap;
                /* Impede que os n√∫meros quebrem linha */
            }

            th {
                padding: 10px 15px;
                font-size: 10px;
            }

            td {
                padding: 15px;
                font-size: 16px;
            }

            .txt-abs {
                font-size: 18px;
            }

            .legenda {
                font-size: 12px;
                padding: 10px;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>üìä Anal√≠tico de Indicadores KPI</h1>
            <a href="index.html" class="btn-voltar">‚¨Ö Voltar ao Lan√ßamento</a>
            <a href="Colab.html" class="btn-voltar">Colaborador</a>
            <a href="coord.html" class="btn-voltar">Supervisor</a>
            <a href="ger.html" class="btn-voltar">Coordenador</a>
        </header>

        <div class="filtro-box">
            <strong>Data de Refer√™ncia:</strong>
            <input type="date" id="dataFiltro" onchange="gerarAnalise()">
        </div>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>PR Œ£x M-1</th>
                        <th>PR Œ£x W-1</th>
                        <th>PR D-1</th>
                        <th>PR (Presen√ßa)</th>
                        <th>F (Falta)</th>
                        <th>FO (Folga)</th>
                        <th>FE (F√©rias)</th>
                        <th>INTJ</th>
                        <th>ABS (Absente√≠smo)</th>
                    </tr>
                </thead>
                <tbody id="corpoTabela"></tbody>
            </table>
        </div>

        <div class="legenda">
            <strong>L√≥gica de Correla√ß√£o ABS:</strong><br>
            O c√°lculo √© a soma direta de <b>(Falta + Folga + F√©rias) / Total de Lan√ßamentos</b>.<br>
            Isso garante que qualquer aus√™ncia impacte negativamente o indicador.
        </div>
    </div>

    <script>
        // CONFIGURA√á√ÉO DO SUPABASE
        const SUPABASE_URL = 'https://dflefctktgxkwhiburgt.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRmbGVmY3RrdGd4a3doaWJ1cmd0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkxMTU2ODMsImV4cCI6MjA4NDY5MTY4M30.R2K3w3VEUiMDRzBi3th5pNPvWSfyZshJ-NuTrDJZZA8';
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        document.addEventListener('DOMContentLoaded', () => {
            const hoje = new Date().toISOString().split('T')[0];
            document.getElementById('dataFiltro').value = hoje;
            gerarAnalise();
        });

        async function gerarAnalise() {
            const dataSelecionada = document.getElementById('dataFiltro').value;
            const corpo = document.getElementById('corpoTabela');

            // --- BUSCA NO SUPABASE EM VEZ DO LOCALSTORAGE ---
            // Buscamos um intervalo maior para calcular o D-1, W-1 e M-1
            const { data: registros, error } = await _supabase
                .from('registros_presenca')
                .select('*');

            if (error) {
                console.error("Erro ao carregar dados:", error);
                return;
            }

            let kpi = {
                pr: 0, f: 0, fo: 0, fe: 0, intj: 0,
                prD1: 0, prW1: 0, prM1: 0, totalDia: 0
            };

            const dataAlvoObj = new Date(dataSelecionada + "T12:00:00");
            const dataOntemStr = new Date(dataAlvoObj.getTime() - 86400000).toISOString().split('T')[0];
            const dataSemanaObj = new Date(dataAlvoObj.getTime() - (7 * 86400000));

            registros.forEach(r => {
                const status = r.status.trim().toUpperCase();
                const rData = r.data;
                const rDataObj = new Date(rData + "T12:00:00");

                const ehPresenca = status.includes("PRESENTE") || status.includes("NOTURNO");
                const ehFalta = status.includes("FALTA") || status.includes("ATESTADO") || status.includes("INSS");
                const ehFolga = status.includes("FOLGA") || status === "FO";
                const ehFerias = status.includes("F√âRIAS") || status.includes("FERIAS") || status === "FE";

                if (rData === dataSelecionada) {
                    kpi.totalDia++;
                    if (ehPresenca) kpi.pr++;
                    if (ehFalta) kpi.f++;
                    if (ehFolga) kpi.fo++;
                    if (ehFerias) kpi.fe++;
                    if (status.includes("INTERJORNADA")) kpi.intj++;
                }

                if (rData === dataOntemStr && ehPresenca) kpi.prD1++;
                if (rDataObj >= dataSemanaObj && rDataObj <= dataAlvoObj && ehPresenca) kpi.prW1++;
                if (rData.substring(0, 7) === dataSelecionada.substring(0, 7) && ehPresenca) kpi.prM1++;
            });

            const somaAusencias = kpi.f + kpi.fo + kpi.fe;
            const valorABS = kpi.totalDia > 0 ? ((somaAusencias / kpi.totalDia) * 100).toFixed(2) : "0.00";
            const valorM1 = (kpi.prM1 / 22).toFixed(2);

            corpo.innerHTML = `
                <tr>
                    <td>${valorM1}</td>
                    <td>${kpi.prW1}</td>
                    <td>${kpi.prD1}</td>
                    <td class="txt-pr">${kpi.pr}</td>
                    <td class="txt-f">${kpi.f}</td>
                    <td class="txt-fo">${kpi.fo}</td>
                    <td class="txt-fe">${kpi.fe}</td>
                    <td>${kpi.intj}</td>
                    <td class="txt-abs">${valorABS}%</td>
                </tr>
            `;
        }
    </script>
</body>

</html>