<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anal√≠tico Operacional - Dashboard</title>
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #34495e;
            --accent: #348ddb;
            --success: #27ae60;
            --danger: #e74c3c;
            --warning: #f39c12;
            --light: #ecf0f1;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f2f5;
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 1300px;
            margin: auto;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 3px solid var(--accent);
            padding-bottom: 20px;
            margin-bottom: 25px;
        }

        .filtro-box {
            background: var(--light);
            padding: 20px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
            border: 1px solid #dcdde1;
        }

        input[type="date"] {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 15px;
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th {
            background-color: var(--primary);
            color: white;
            padding: 15px;
            font-size: 11px;
            text-transform: uppercase;
        }

        td {
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid #eee;
            font-size: 17px;
            font-weight: 700;
        }

        .txt-pr {
            color: var(--success);
        }

        .txt-f {
            color: var(--danger);
        }

        .txt-fo {
            color: var(--warning);
        }

        .txt-fe {
            color: var(--accent);
        }

        .txt-abs {
            color: #8e44ad;
            font-size: 22px;
            background: #f8f0fb;
            padding: 5px 10px;
            border-radius: 8px;
        }

        .btn-voltar {
            background: var(--secondary);
            color: white;
            padding: 10px 20px;
            text-decoration: none;
            border-radius: 6px;
            font-weight: bold;
        }

        .legenda {
            margin-top: 30px;
            padding: 15px;
            background: #fffdf0;
            border-left: 5px solid var(--warning);
            font-size: 13px;
        }
    </style>
</head>

<body>

    <div class="container">
        <header>
            <h1>üìä Anal√≠tico de Indicadores KPI</h1>
            <a href="index.html" class="btn-voltar">‚¨Ö Voltar ao Lan√ßamento</a>
        </header>

        <div class="filtro-box">
            <strong>Data de Refer√™ncia:</strong>
            <input type="date" id="dataFiltro" onchange="gerarAnalise()">
        </div>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>PR Œ£x M-1</th>
                        <th>PR Œ£x W-1</th>
                        <th>PR D-1</th>
                        <th>PR (Presen√ßa)</th>
                        <th>F (Falta)</th>
                        <th>FO (Folga)</th>
                        <th>FE (F√©rias)</th>
                        <th>INTJ</th>
                        <th>ABS (Absente√≠smo)</th>
                    </tr>
                </thead>
                <tbody id="corpoTabela"></tbody>
            </table>
        </div>

        <div class="legenda">
            <strong>L√≥gica de Correla√ß√£o ABS:</strong><br>
            O c√°lculo √© a soma direta de <b>(Falta + Folga + F√©rias) / Total de Lan√ßamentos</b>.<br>
            Isso garante que qualquer aus√™ncia impacte negativamente o indicador.
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const hoje = new Date().toISOString().split('T')[0];
            document.getElementById('dataFiltro').value = hoje;
            gerarAnalise();
        });

        function gerarAnalise() {
            const registros = JSON.parse(localStorage.getItem('registros_presenca')) || [];
            const dataSelecionada = document.getElementById('dataFiltro').value;
            const corpo = document.getElementById('corpoTabela');

            let kpi = {
                pr: 0, f: 0, fo: 0, fe: 0, intj: 0,
                prD1: 0, prW1: 0, prM1: 0, totalDia: 0
            };

            // Datas para compara√ß√£o
            const dataAlvoObj = new Date(dataSelecionada + "T12:00:00");
            const dataOntemStr = new Date(dataAlvoObj.getTime() - 86400000).toISOString().split('T')[0];
            const dataSemanaObj = new Date(dataAlvoObj.getTime() - (7 * 86400000));

            registros.forEach(r => {
                const status = r.status.trim().toUpperCase();
                const rData = r.data;
                const rDataObj = new Date(rData + "T12:00:00");

                // Identificadores de Status
                const ehPresenca = status.includes("PRESENTE") || status.includes("NOTURNO");
                const ehFalta = status.includes("FALTA") || status.includes("ATESTADO") || status.includes("INSS");
                const ehFolga = status.includes("FOLGA") || status === "FO";
                const ehFerias = status.includes("F√âRIAS") || status.includes("FERIAS") || status === "FE";

                // Contagem do Dia Selecionado
                if (rData === dataSelecionada) {
                    kpi.totalDia++; // Incrementa o divisor (Total)

                    if (ehPresenca) kpi.pr++;
                    if (ehFalta) kpi.f++;
                    if (ehFolga) kpi.fo++;
                    if (ehFerias) kpi.fe++;
                    if (status.includes("INTERJORNADA")) kpi.intj++;
                }

                // Correla√ß√µes Temporais
                if (rData === dataOntemStr && ehPresenca) kpi.prD1++;
                if (rDataObj >= dataSemanaObj && rDataObj <= dataAlvoObj && ehPresenca) kpi.prW1++;
                if (rData.substring(0, 7) === dataSelecionada.substring(0, 7) && ehPresenca) kpi.prM1++;
            });

            // APLICA√á√ÉO DA CORRELA√á√ÉO ABS: (Falta + Folga + F√©rias) / Total
            const somaAusencias = kpi.f + kpi.fo + kpi.fe;
            const valorABS = kpi.totalDia > 0 ? ((somaAusencias / kpi.totalDia) * 100).toFixed(2) : "0.00";

            // C√°lculo M-1 (M√©dia aproximada)
            const valorM1 = (kpi.prM1 / 22).toFixed(2);

            corpo.innerHTML = `
                <tr>
                    <td>${valorM1}</td>
                    <td>${kpi.prW1}</td>
                    <td>${kpi.prD1}</td>
                    <td class="txt-pr">${kpi.pr}</td>
                    <td class="txt-f">${kpi.f}</td>
                    <td class="txt-fo">${kpi.fo}</td>
                    <td class="txt-fe">${kpi.fe}</td>
                    <td>${kpi.intj}</td>
                    <td class="txt-abs">${valorABS}%</td>
                </tr>
            `;
        }
    </script>
</body>

</html>